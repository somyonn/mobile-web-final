{% extends 'blog/base.html' %}
{% load static %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">ğŸ“Š ê¸ˆì—° ì¶”ì„¸</h2>
        
        <!-- ê¸°ê°„ ì„ íƒ ë²„íŠ¼ -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="btn-group w-100" role="group" id="periodButtons">
                    <button type="button" class="btn btn-primary active" data-period="hourly">ì‹œê°„ë³„</button>
                    <button type="button" class="btn btn-outline-primary" data-period="daily">ìš”ì¼ë³„</button>
                    <button type="button" class="btn btn-outline-primary" data-period="monthly">30ì¼ê°„</button>
                </div>
            </div>
        </div>
        
        <!-- ê·¸ë˜í”„ -->
        <div class="card">
            <div class="card-body">
                <canvas id="trendChart" height="100"></canvas>
            </div>
        </div>
        
        <!-- í†µê³„ ì •ë³´ -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">í†µê³„ ì •ë³´</h5>
                <div id="statistics" class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 id="totalCount" class="text-primary">0</h3>
                            <p class="text-muted">ì´ ê¸°ë¡</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 id="avgCount" class="text-success">0</h3>
                            <p class="text-muted">í‰ê· </p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 id="maxCount" class="text-danger">0</h3>
                            <p class="text-muted">ìµœëŒ€</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3 id="minCount" class="text-info">0</h3>
                            <p class="text-muted">ìµœì†Œ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let trendChart = null;
let currentPeriod = 'hourly';

function loadChart(period) {
    currentPeriod = period;
    
    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    document.querySelectorAll('#periodButtons button').forEach(btn => {
        if (btn.dataset.period === period) {
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('active', 'btn-primary');
        } else {
            btn.classList.remove('active', 'btn-primary');
            btn.classList.add('btn-outline-primary');
        }
    });
    
    // API í˜¸ì¶œ
    fetch(`/api/trend-data/?period=${period}`)
        .then(response => response.json())
        .then(data => {
            updateChart(data);
            updateStatistics(data);
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

// ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('#periodButtons button').forEach(btn => {
        btn.addEventListener('click', function() {
            loadChart(this.dataset.period);
        });
    });
});

function updateChart(data) {
    const ctx = document.getElementById('trendChart').getContext('2d');
    
    // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
    if (trendChart) {
        trendChart.destroy();
    }
    
    const chartType = currentPeriod === 'monthly' ? 'line' : 'bar';
    
    trendChart = new Chart(ctx, {
        type: chartType,
        data: {
            labels: data.labels,
            datasets: [{
                label: 'í¡ì—° íšŸìˆ˜',
                data: data.values,
                backgroundColor: currentPeriod === 'monthly' 
                    ? 'rgba(98, 0, 238, 0.2)' 
                    : 'rgba(98, 0, 238, 0.6)',
                borderColor: 'rgba(98, 0, 238, 1)',
                borderWidth: 2,
                fill: currentPeriod === 'monthly',
                tension: currentPeriod === 'monthly' ? 0.4 : 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
}

function updateStatistics(data) {
    const values = data.values;
    const total = values.reduce((a, b) => a + b, 0);
    const avg = values.length > 0 ? (total / values.length).toFixed(1) : 0;
    const max = Math.max(...values);
    const min = Math.min(...values.filter(v => v > 0)) || 0;
    
    document.getElementById('totalCount').textContent = total;
    document.getElementById('avgCount').textContent = avg;
    document.getElementById('maxCount').textContent = max;
    document.getElementById('minCount').textContent = min;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œê°„ë³„ ì°¨íŠ¸ ë¡œë“œ
window.addEventListener('DOMContentLoaded', function() {
    // ë²„íŠ¼ ì´ë²¤íŠ¸ëŠ” ìœ„ì—ì„œ ì´ë¯¸ ì„¤ì •ë¨
    loadChart('hourly');
});
</script>
{% endblock %}

